<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NPS Real Time Engine V2</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#0b0f14;--bg2:#111820;--bg3:#161e28;
  --glass:rgba(255,255,255,0.04);--glass2:rgba(255,255,255,0.07);
  --border:rgba(255,255,255,0.07);--border2:rgba(255,255,255,0.12);
  --t1:#f0f2f5;--t2:#8a94a6;--t3:#505a6b;
  --green:#00e676;--greenBg:rgba(0,230,118,0.10);--greenGl:rgba(0,230,118,0.25);
  --yellow:#ffd600;--yellowBg:rgba(255,214,0,0.10);--yellowGl:rgba(255,214,0,0.25);
  --red:#ff5252;--redBg:rgba(255,82,82,0.10);--redGl:rgba(255,82,82,0.25);
  --indigo:#536dfe;--indigoBg:rgba(83,109,254,0.10);--indigoGl:rgba(83,109,254,0.25);
  --purple:#b388ff;--cyan:#00e5ff;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--t1);min-height:100vh;overflow-x:hidden;}

/* â•â•â• PARTICLES â•â•â• */
#particles{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0;overflow:hidden;}
.particle{position:absolute;border-radius:50%;opacity:0.12;animation:fp linear infinite;}
@keyframes fp{0%{transform:translateY(100vh) scale(0);opacity:0}10%{opacity:0.12}90%{opacity:0.12}100%{transform:translateY(-10vh) scale(1);opacity:0}}

/* â•â•â• APP â•â•â• */
.app{position:relative;z-index:1;max-width:1440px;margin:0 auto;padding:16px 20px;}

/* â•â•â• HEADER â•â•â• */
.hdr{display:flex;align-items:center;justify-content:space-between;padding:16px 24px;margin-bottom:16px;background:var(--glass);border:1px solid var(--border);border-radius:18px;backdrop-filter:blur(20px);}
.hdr-l{display:flex;align-items:center;gap:14px;}
.hdr-logo{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--indigo),var(--purple));display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:800;color:#fff;}
.hdr-t{font-size:18px;font-weight:700;letter-spacing:-0.5px;}
.hdr-s{font-size:11px;color:var(--t2);margin-top:1px;}
.live-b{display:flex;align-items:center;gap:8px;padding:7px 14px;border-radius:30px;background:rgba(255,82,82,0.1);border:1px solid rgba(255,82,82,0.2);font-size:12px;font-weight:600;color:var(--red);}
.live-d{width:9px;height:9px;border-radius:50%;background:var(--red);animation:pd 1.5s ease-in-out infinite;}
@keyframes pd{0%,100%{box-shadow:0 0 0 0 rgba(255,82,82,0.5)}50%{box-shadow:0 0 0 7px rgba(255,82,82,0)}}

/* â•â•â• TABS â•â•â• */
.tabs{display:flex;gap:4px;margin-bottom:16px;background:var(--glass);border:1px solid var(--border);border-radius:14px;padding:4px;width:fit-content;}
.tab{padding:10px 24px;border-radius:11px;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.3s;color:var(--t2);border:1px solid transparent;display:flex;align-items:center;gap:6px;}
.tab:hover{color:var(--t1);}
.tab.active{background:var(--glass2);color:var(--t1);border-color:var(--border2);box-shadow:0 2px 12px rgba(0,0,0,0.2);}
.tab-panel{display:none;}
.tab-panel.active{display:block;}

/* â•â•â• CLOCK ROW â•â•â• */
.clock-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;padding:0 4px;}
.clock{font-size:13px;color:var(--t2);display:flex;align-items:center;gap:6px;}
.clock b{color:var(--t1);font-size:15px;}
.next-cierre{font-size:12px;color:var(--t3);background:var(--glass);padding:6px 14px;border-radius:10px;border:1px solid var(--border);}
.ayer-vs-hoy{font-size:12px;color:var(--t2);background:var(--glass);padding:6px 14px;border-radius:10px;border:1px solid var(--border);}
.ayer-vs-hoy b{color:var(--t1);}

/* â•â•â• 3 COL LAYOUT (like Looker) â•â•â• */
.trio{display:grid;grid-template-columns:280px 1fr 280px;gap:16px;margin-bottom:16px;}
.trio-col{background:var(--glass);border:1px solid var(--border);border-radius:16px;padding:18px;backdrop-filter:blur(12px);}
.trio-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--t3);margin-bottom:14px;display:flex;align-items:center;gap:6px;}

/* â•â•â• STAT PILLS â•â•â• */
.spills{display:flex;gap:8px;margin-bottom:14px;justify-content:center;}
.spill{padding:6px 14px;border-radius:10px;font-size:18px;font-weight:800;text-align:center;min-width:54px;}
.spill.p{background:var(--greenBg);color:var(--green);border:1px solid rgba(0,230,118,0.15);}
.spill.n{background:var(--yellowBg);color:var(--yellow);border:1px solid rgba(255,214,0,0.15);}
.spill.d{background:var(--redBg);color:var(--red);border:1px solid rgba(255,82,82,0.15);}

/* â•â•â• BIG NPS â•â•â• */
.big-nps{text-align:center;margin-bottom:14px;}
.big-nps-label{font-size:11px;color:var(--t3);font-weight:600;text-transform:uppercase;letter-spacing:1px;}
.big-nps-val{font-size:42px;font-weight:900;letter-spacing:-2px;line-height:1;}
.big-enc{font-size:32px;font-weight:800;text-align:center;color:var(--t1);line-height:1;}
.big-enc-label{font-size:11px;color:var(--t3);text-align:center;text-transform:uppercase;font-weight:600;letter-spacing:1px;margin-bottom:4px;}

/* â•â•â• TOP CARD â•â•â• */
.top-card{background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:10px;}
.top-card-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--t3);margin-bottom:8px;}
.top-card-row{display:flex;align-items:center;justify-content:space-between;font-size:12px;}
.top-card-name{font-weight:600;color:var(--t1);}
.top-card-enc{color:var(--t2);}
.top-card-nps{font-weight:700;}

/* â•â•â• CHART â•â•â• */
.chart-wrap{position:relative;height:220px;}
.meta-line-label{position:absolute;top:8px;right:8px;font-size:10px;color:var(--yellow);font-weight:600;background:var(--yellowBg);padding:3px 8px;border-radius:6px;}

/* â•â•â• THERMO â•â•â• */
.thermo{display:flex;align-items:center;gap:8px;justify-content:center;margin-bottom:12px;padding:8px 14px;border-radius:10px;background:var(--glass);border:1px solid var(--border);font-size:12px;font-weight:600;}

/* â•â•â• NPS BAR â•â•â• */
.nps-bar-sec{margin-bottom:16px;}
.nps-bar-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;padding:0 4px;}
.nps-bar-l{font-size:12px;font-weight:600;color:var(--t2);}
.nps-bar-v{font-size:20px;font-weight:800;}
.nps-track{height:12px;background:var(--glass);border-radius:8px;overflow:hidden;position:relative;border:1px solid var(--border);}
.nps-fill{height:100%;border-radius:8px;transition:width 0.8s cubic-bezier(0.16,1,0.3,1),background 0.5s;position:relative;}
.nps-fill::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.15),transparent);animation:sh 2s infinite;}
@keyframes sh{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
.nps-meta{position:absolute;top:-5px;bottom:-5px;width:2px;background:var(--yellow);border-radius:2px;z-index:2;transition:left 0.8s;}
.nps-meta span{position:absolute;top:-18px;transform:translateX(-50%);font-size:9px;font-weight:700;color:var(--yellow);white-space:nowrap;}

/* â•â•â• MAIN GRID â•â•â• */
.mgrid{display:grid;grid-template-columns:1fr 360px;gap:16px;margin-bottom:16px;}

/* â•â•â• SECTION CARD â•â•â• */
.scard{background:var(--glass);border:1px solid var(--border);border-radius:16px;padding:18px;backdrop-filter:blur(12px);}
.stitle{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--t3);margin-bottom:14px;display:flex;align-items:center;gap:6px;}

/* â•â•â• RACHAS â•â•â• */
.rrow{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:11px;margin-bottom:6px;transition:all 0.3s;background:rgba(255,255,255,0.015);border:1px solid transparent;}
.rrow:hover{background:rgba(255,255,255,0.03);border-color:var(--border);}
.ravatar{width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0;}
.rinfo{flex:1;min-width:0;}
.rname{font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.rstats{font-size:10px;color:var(--t3);margin-top:1px;}
.rdots{display:flex;gap:3px;flex-wrap:wrap;margin-top:3px;}
.rdot{width:18px;height:18px;border-radius:5px;font-size:9px;display:flex;align-items:center;justify-content:center;font-weight:700;animation:di 0.4s cubic-bezier(0.34,1.56,0.64,1) backwards;}
@keyframes di{from{transform:scale(0);opacity:0}to{transform:scale(1);opacity:1}}
.rdot.P{background:var(--greenBg);color:var(--green);border:1px solid rgba(0,230,118,0.15);}
.rdot.N{background:var(--yellowBg);color:var(--yellow);border:1px solid rgba(255,214,0,0.15);}
.rdot.D{background:var(--redBg);color:var(--red);border:1px solid rgba(255,82,82,0.15);}
.rstreak{font-size:11px;font-weight:700;padding:3px 9px;border-radius:7px;white-space:nowrap;}

/* â•â•â• FEED â•â•â• */
.feed{max-height:460px;overflow-y:auto;padding-right:4px;}
.feed::-webkit-scrollbar{width:3px;}
.feed::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.08);border-radius:3px;}
.acard{padding:14px;border-radius:12px;margin-bottom:8px;border:1px solid;animation:si 0.5s cubic-bezier(0.16,1,0.3,1);position:relative;overflow:hidden;}
@keyframes si{from{transform:translateX(50px);opacity:0}to{transform:translateX(0);opacity:1}}
.acard.det{background:var(--redBg);border-color:rgba(255,82,82,0.15);}
.acard.pro{background:var(--greenBg);border-color:rgba(0,230,118,0.15);}
.acard.neu{background:var(--yellowBg);border-color:rgba(255,214,0,0.15);}
.acard.pat{background:var(--indigoBg);border-color:rgba(83,109,254,0.15);}
.acard.ach{background:linear-gradient(135deg,rgba(179,136,255,0.1),rgba(0,229,255,0.06));border-color:rgba(179,136,255,0.2);}
.ah{display:flex;align-items:center;gap:6px;margin-bottom:6px;}
.ai{font-size:16px;}
.at{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;}
.atm{font-size:9px;color:var(--t3);margin-left:auto;}
.ab{font-size:11px;line-height:1.5;color:var(--t2);}
.ab strong{color:var(--t1);font-weight:600;}
.espejo{margin-top:8px;padding:8px 10px;border-radius:9px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.05);}
.espejo-t{font-size:9px;font-weight:700;color:var(--green);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:4px;}
.espejo-i{font-size:10px;color:var(--t2);margin-bottom:2px;}
.pbox{margin-top:8px;padding:8px 10px;border-radius:9px;background:rgba(83,109,254,0.06);border:1px solid rgba(83,109,254,0.1);}
.pbox-t{font-size:9px;font-weight:700;color:var(--indigo);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:3px;}

/* â•â•â• TABLE â•â•â• */
.enc-table{width:100%;border-collapse:collapse;font-size:11px;}
.enc-table th{text-align:left;padding:8px 10px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--t3);border-bottom:1px solid var(--border);}
.enc-table td{padding:7px 10px;border-bottom:1px solid rgba(255,255,255,0.03);color:var(--t2);}
.enc-table tr:hover td{background:rgba(255,255,255,0.02);}
.nps-pill{padding:2px 8px;border-radius:6px;font-weight:700;font-size:10px;}
.nps-pill.p{background:var(--greenBg);color:var(--green);}
.nps-pill.n{background:var(--yellowBg);color:var(--yellow);}
.nps-pill.d{background:var(--redBg);color:var(--red);}
.table-wrap{max-height:240px;overflow-y:auto;border-radius:12px;border:1px solid var(--border);}
.table-wrap::-webkit-scrollbar{width:3px;}
.table-wrap::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.08);border-radius:3px;}

/* â•â•â• EMPTY STATE â•â•â• */
.empty-state{text-align:center;padding:50px 20px;}
.empty-emoji{font-size:56px;margin-bottom:12px;animation:bounce 1s ease infinite alternate;}
@keyframes bounce{from{transform:translateY(0)}to{transform:translateY(-10px)}}
.empty-title{font-size:18px;font-weight:700;margin-bottom:6px;}
.empty-sub{font-size:13px;color:var(--t2);line-height:1.6;}

/* â•â•â• SIM BTNS â•â•â• */
.sim-sec{background:var(--glass);border:1px solid var(--border);border-radius:16px;padding:18px;margin-bottom:16px;}
.sgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;}
.sbtn{padding:12px 8px;border-radius:12px;border:1px solid;font-family:'Inter',sans-serif;font-size:11px;font-weight:600;cursor:pointer;transition:all 0.3s;display:flex;flex-direction:column;align-items:center;gap:5px;text-align:center;}
.sbtn:hover{transform:translateY(-2px);}
.sbtn:active{transform:scale(0.96);}
.sbtn.gb{background:var(--greenBg);border-color:rgba(0,230,118,0.15);color:var(--green);}
.sbtn.gb:hover{box-shadow:0 4px 16px var(--greenGl);}
.sbtn.rb{background:var(--redBg);border-color:rgba(255,82,82,0.15);color:var(--red);}
.sbtn.rb:hover{box-shadow:0 4px 16px var(--redGl);}
.sbtn.yb{background:var(--yellowBg);border-color:rgba(255,214,0,0.15);color:var(--yellow);}
.sbtn.yb:hover{box-shadow:0 4px 16px var(--yellowGl);}
.sbtn.ib{background:var(--indigoBg);border-color:rgba(83,109,254,0.15);color:var(--indigo);}
.sbtn.ib:hover{box-shadow:0 4px 16px var(--indigoGl);}
.sbtn.pb{background:rgba(179,136,255,0.08);border-color:rgba(179,136,255,0.15);color:var(--purple);}
.sbtn.pb:hover{box-shadow:0 4px 16px rgba(179,136,255,0.25);}
.sbtn-i{font-size:22px;}

/* â•â•â• ACHIEVEMENT â•â•â• */
.ach-ov{position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;animation:fi 0.3s;}
.ach-ov.show{display:flex;}
@keyframes fi{from{opacity:0}to{opacity:1}}
.ach-box{text-align:center;padding:44px 56px;border-radius:26px;background:linear-gradient(135deg,rgba(179,136,255,0.12),rgba(0,229,255,0.08));border:1px solid rgba(179,136,255,0.25);backdrop-filter:blur(20px);animation:ai2 0.6s cubic-bezier(0.34,1.56,0.64,1);}
@keyframes ai2{from{transform:scale(0.5) rotate(-5deg);opacity:0}to{transform:scale(1) rotate(0);opacity:1}}
.ach-emoji{font-size:64px;margin-bottom:14px;animation:bounce 0.8s ease infinite alternate;}
.ach-title{font-size:22px;font-weight:800;background:linear-gradient(135deg,var(--purple),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px;}
.ach-desc{font-size:13px;color:var(--t2);}
.ach-close{margin-top:18px;padding:9px 26px;border-radius:11px;border:1px solid rgba(179,136,255,0.25);background:rgba(179,136,255,0.08);color:var(--purple);font-weight:600;cursor:pointer;font-size:12px;transition:all 0.3s;}
.ach-close:hover{background:rgba(179,136,255,0.15);}

/* â•â•â• CIERRE â•â•â• */
.ci-ov{position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.75);backdrop-filter:blur(10px);display:none;align-items:center;justify-content:center;}
.ci-ov.show{display:flex;}
.ci-box{width:90%;max-width:580px;padding:32px;border-radius:22px;background:var(--bg2);border:1px solid var(--border);animation:ai2 0.5s cubic-bezier(0.16,1,0.3,1);}
.ci-hdr{text-align:center;margin-bottom:20px;}
.ci-tl{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:var(--indigo);margin-bottom:4px;}
.ci-hr{font-size:26px;font-weight:800;}
.ci-week{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:20px;}
.ci-day{text-align:center;padding:12px 6px;border-radius:12px;background:var(--glass);border:1px solid var(--border);transition:all 0.3s;}
.ci-day.today{border-color:var(--indigo);background:var(--indigoBg);}
.ci-day.future{opacity:0.3;}
.ci-dn{font-size:10px;font-weight:700;color:var(--t3);text-transform:uppercase;margin-bottom:4px;}
.ci-de{font-size:20px;font-weight:800;margin-bottom:1px;}
.ci-dp{font-size:12px;font-weight:600;}
.ci-sum{text-align:center;padding:16px;border-radius:12px;background:var(--glass);border:1px solid var(--border);margin-bottom:16px;}
.ci-sn{font-size:30px;font-weight:800;}
.ci-sl{font-size:11px;color:var(--t2);margin-top:3px;}
.ci-msg{text-align:center;font-size:13px;color:var(--t2);line-height:1.7;font-style:italic;}
.ci-close{display:block;margin:18px auto 0;padding:9px 28px;border-radius:11px;border:1px solid var(--border);background:var(--glass);color:var(--t1);font-weight:600;cursor:pointer;font-size:12px;transition:all 0.3s;}
.ci-close:hover{background:var(--glass2);}

/* â•â•â• FLASH â•â•â• */
.flash-ov{position:fixed;inset:0;pointer-events:none;z-index:999;opacity:0;transition:opacity 0.1s;}
.flash-ov.r{background:rgba(255,82,82,0.12);}
.flash-ov.g{background:rgba(0,230,118,0.08);}
.flash-ov.show{opacity:1;}

/* â•â•â• CONFETTI â•â•â• */
.confetti{position:fixed;z-index:1001;animation:cf linear forwards;pointer-events:none;}
@keyframes cf{0%{transform:translateY(-10vh) rotate(0);opacity:1}100%{transform:translateY(110vh) rotate(720deg);opacity:0}}

/* â•â•â• FOOTER â•â•â• */
.ftr{text-align:center;padding:18px;font-size:10px;color:var(--t3);}

/* â•â•â• RESPONSIVE â•â•â• */
@media(max-width:1100px){.trio{grid-template-columns:1fr;}.mgrid{grid-template-columns:1fr;}}
@media(max-width:700px){.sgrid{grid-template-columns:repeat(2,1fr);}.hdr{flex-direction:column;gap:10px;text-align:center;}.ci-week{grid-template-columns:repeat(3,1fr);}.spills{flex-wrap:wrap;}}
@keyframes shake{0%,100%{transform:translateX(0)}10%,30%,50%,70%,90%{transform:translateX(-3px)}20%,40%,60%,80%{transform:translateX(3px)}}
</style>
</head>
<body>
<div id="particles"></div>
<div class="flash-ov r" id="flR"></div>
<div class="flash-ov g" id="flG"></div>

<!-- ACHIEVEMENT -->
<div class="ach-ov" id="achOv">
  <div class="ach-box">
    <div class="ach-emoji" id="achE">ğŸ’</div>
    <div class="ach-title" id="achT">Â¡LOGRO DESBLOQUEADO!</div>
    <div class="ach-desc" id="achD"></div>
    <button class="ach-close" onclick="document.getElementById('achOv').classList.remove('show')">Â¡Genial! âœ¨</button>
  </div>
</div>

<!-- CIERRE -->
<div class="ci-ov" id="ciOv">
  <div class="ci-box">
    <div class="ci-hdr"><div class="ci-tl" id="ciTL"></div><div class="ci-hr" id="ciHR"></div></div>
    <div class="ci-week" id="ciWK"></div>
    <div class="ci-sum"><div class="ci-sn" id="ciSN">--</div><div class="ci-sl">NPS Acumulado Semana Â· Meta: 36.6%</div></div>
    <div class="ci-msg" id="ciMG"></div>
    <button class="ci-close" onclick="document.getElementById('ciOv').classList.remove('show')">Cerrar</button>
  </div>
</div>

<!-- APP -->
<div class="app">

  <!-- HEADER -->
  <div class="hdr">
    <div class="hdr-l">
      <div class="hdr-logo">N</div>
      <div><div class="hdr-t">NPS Real Time Engine</div><div class="hdr-s">Publicaciones Sellers Mature Â· V2</div></div>
    </div>
    <div class="live-b"><div class="live-d"></div>LIVE</div>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <div class="tab active" onclick="switchTab('rt')" id="tabRT">ğŸ“¡ Real Time</div>
    <div class="tab" onclick="switchTab('sim')" id="tabSIM">ğŸ® Simulador</div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- TAB: REAL TIME           -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-panel active" id="panelRT">

    <!-- Clock Row -->
    <div class="clock-row">
      <div class="clock">â° <b id="clockDisplay">--:--</b></div>
      <div class="ayer-vs-hoy" id="ayerVsHoy">Ayer a esta hora: <b>8 enc Â· 37.5%</b> â†’ Hoy: <b>0 enc Â· --%</b></div>
      <div class="next-cierre" id="nextCierre">PrÃ³ximo cierre: 12:25 PM</div>
    </div>

    <!-- Trio layout -->
    <div class="trio">
      <!-- LEFT: Resultados Ayer -->
      <div class="trio-col">
        <div class="trio-title">ğŸ“‹ Resultados Ayer</div>
        <div class="big-enc-label">Encuestas</div>
        <div class="big-enc" id="rtAyerEnc">25</div>
        <div style="height:10px"></div>
        <div class="big-nps">
          <div class="big-nps-label">NPS Lineal</div>
          <div class="big-nps-val" id="rtAyerNps" style="color:var(--green)">44.0%</div>
        </div>
        <div class="spills" id="rtAyerPills">
          <div class="spill p">16</div>
          <div class="spill n">4</div>
          <div class="spill d">5</div>
        </div>
        <div class="top-card">
          <div class="top-card-title">ğŸ† Top Rep Ayer</div>
          <div class="top-card-row">
            <span class="top-card-name">Valentina RÃ­os</span>
            <span class="top-card-enc">4 enc</span>
            <span class="top-card-nps" style="color:var(--green)">100%</span>
          </div>
        </div>
        <div class="top-card">
          <div class="top-card-title">ğŸ… Top Equipo Ayer</div>
          <div class="top-card-row">
            <span class="top-card-name">Equipo Lnocua</span>
            <span class="top-card-enc">1 enc</span>
            <span class="top-card-nps" style="color:var(--green)">100%</span>
          </div>
        </div>
      </div>

      <!-- CENTER: GrÃ¡fica por Horas -->
      <div class="trio-col">
        <div class="trio-title">ğŸ“ˆ Desarrollo del DÃ­a por Horas</div>
        <div class="chart-wrap">
          <canvas id="chartHoras"></canvas>
          <div class="meta-line-label">Meta 36.6%</div>
        </div>
      </div>

      <!-- RIGHT: NPS Hoy -->
      <div class="trio-col" id="rtHoyCol">
        <div class="trio-title" style="justify-content:space-between;">
          NPS Real Time
          <div class="live-b" style="padding:4px 10px;font-size:10px;"><div class="live-d" style="width:7px;height:7px;"></div>LIVE</div>
        </div>
        <div class="big-enc-label">Encuestas</div>
        <div class="big-enc" id="rtHoyEnc">0</div>
        <div style="height:10px"></div>
        <div class="big-nps">
          <div class="big-nps-label">NPS Lineal Hoy</div>
          <div class="big-nps-val" id="rtHoyNps" style="color:var(--t3)">--%</div>
        </div>
        <div class="spills" id="rtHoyPills">
          <div class="spill p" id="rtHP">0</div>
          <div class="spill n" id="rtHN">0</div>
          <div class="spill d" id="rtHD">0</div>
        </div>
        <div class="top-card">
          <div class="top-card-title">ğŸ† Top Rep Hoy</div>
          <div class="top-card-row" id="rtTopRepHoy">
            <span style="color:var(--t3);font-size:11px;">Esperando encuestas...</span>
          </div>
        </div>
        <div class="top-card">
          <div class="top-card-title">ğŸ… Top Equipo Hoy</div>
          <div class="top-card-row" id="rtTopEqHoy">
            <span style="color:var(--t3);font-size:11px;">Esperando encuestas...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Thermo -->
    <div class="thermo" id="rtThermo">ğŸ§Š TermÃ³metro del equipo: <span style="margin-left:4px;" id="rtThermoText">Sin actividad aÃºn â€” Â¿QuiÃ©n serÃ¡ el primer promotor del dÃ­a? ğŸš€</span></div>

    <!-- NPS Bar -->
    <div class="nps-bar-sec">
      <div class="nps-bar-h">
        <span class="nps-bar-l">NPS HOY</span>
        <span class="nps-bar-v" id="rtBarVal" style="color:var(--t3)">--%</span>
      </div>
      <div class="nps-track" style="position:relative">
        <div class="nps-fill" id="rtBarFill" style="width:50%;background:var(--t3)"></div>
        <div class="nps-meta" id="rtBarMeta" style="left:68.3%"><span>Meta 36.6%</span></div>
      </div>
    </div>

    <!-- Rachas + Feed -->
    <div class="mgrid">
      <div class="scard">
        <div class="stitle">ğŸ”¥ Rachas en Vivo</div>
        <div id="rtRachas">
          <div class="empty-state">
            <div class="empty-emoji">ğŸš€</div>
            <div class="empty-title">Â¿QuÃ© esperas?</div>
            <div class="empty-sub">SÃ© el primer promotor del dÃ­a.<br>Cada encuesta cuenta, Â¡arrancamos!</div>
          </div>
        </div>
      </div>
      <div class="scard">
        <div class="stitle">ğŸ“¡ Feed en Tiempo Real</div>
        <div class="feed" id="rtFeed">
          <div class="empty-state" style="padding:30px 10px;">
            <div class="empty-emoji" style="font-size:40px;">ğŸ“¡</div>
            <div class="empty-title" style="font-size:15px;">Escuchando...</div>
            <div class="empty-sub" style="font-size:12px;">Las alertas aparecerÃ¡n aquÃ­<br>cuando lleguen encuestas</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="scard">
      <div class="stitle">ğŸ“‹ Encuestas del DÃ­a</div>
      <div class="table-wrap">
        <table class="enc-table">
          <thead><tr><th>Hora</th><th>Caso</th><th>LÃ­der</th><th>Rep</th><th>SoluciÃ³n</th><th>Comentario</th><th>NPS</th></tr></thead>
          <tbody id="rtTableBody">
            <tr><td colspan="7" style="text-align:center;padding:24px;color:var(--t3)">Sin encuestas aÃºn</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- TAB: SIMULADOR           -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-panel" id="panelSIM">

    <!-- Sim Buttons -->
    <div class="sim-sec">
      <div class="stitle">ğŸ® Panel de SimulaciÃ³n</div>
      <p style="font-size:12px;color:var(--t2);margin-bottom:14px;line-height:1.5;">Cada botÃ³n simula un evento en tiempo real. Los datos se reflejan en la pestaÃ±a <b>Real Time</b>. Â¡PruÃ©balos!</p>
      <div class="sgrid">
        <button class="sbtn gb" onclick="simPromotor()"><span class="sbtn-i">ğŸŸ¢</span>Llega Promotor</button>
        <button class="sbtn rb" onclick="simDetractor()"><span class="sbtn-i">ğŸ”´</span>Llega Detractor</button>
        <button class="sbtn yb" onclick="simNeutro()"><span class="sbtn-i">ğŸŸ¡</span>Llega Neutro</button>
        <button class="sbtn ib" onclick="simCierreAM()"><span class="sbtn-i">ğŸŒ…</span>Cierre AM 12:25</button>
        <button class="sbtn ib" onclick="simCierrePM()"><span class="sbtn-i">ğŸŒ‡</span>Cierre PM 6:30</button>
        <button class="sbtn pb" onclick="simLogro()"><span class="sbtn-i">ğŸ†</span>Logro</button>
        <button class="sbtn pb" onclick="simPatron()"><span class="sbtn-i">ğŸ§ </span>Alerta PatrÃ³n</button>
        <button class="sbtn" style="background:var(--glass);border-color:var(--border);color:var(--t2);" onclick="simAutoPlay()"><span class="sbtn-i">âš¡</span>Auto-Play (Demo)</button>
      </div>
    </div>

    <!-- Mirror of stats -->
    <div class="nps-bar-sec">
      <div class="nps-bar-h"><span class="nps-bar-l">NPS HOY (SimulaciÃ³n)</span><span class="nps-bar-v" id="simBarVal" style="color:var(--t3)">--%</span></div>
      <div class="nps-track" style="position:relative"><div class="nps-fill" id="simBarFill" style="width:50%;background:var(--t3)"></div><div class="nps-meta" style="left:68.3%"><span>Meta 36.6%</span></div></div>
    </div>

    <div class="mgrid">
      <div class="scard">
        <div class="stitle">ğŸ”¥ Rachas (SimulaciÃ³n)</div>
        <div id="simRachas">
          <div class="empty-state"><div class="empty-emoji">ğŸ®</div><div class="empty-title">Simulador listo</div><div class="empty-sub">Oprime los botones para ver<br>cÃ³mo funciona el engine</div></div>
        </div>
      </div>
      <div class="scard">
        <div class="stitle">ğŸ“¡ Feed (SimulaciÃ³n)</div>
        <div class="feed" id="simFeed">
          <div class="empty-state" style="padding:30px 10px;"><div class="empty-emoji" style="font-size:40px;">ğŸ®</div><div class="empty-title" style="font-size:15px;">Listo para simular</div><div class="empty-sub" style="font-size:12px;">Las alertas simuladas<br>aparecerÃ¡n aquÃ­</div></div>
        </div>
      </div>
    </div>
  </div>

  <div class="ftr">hecho por juan sebastian guerrero rodriguez, hecho con el ğŸ’›<br><span style="font-size:9px;opacity:0.5;">NPS Real Time Engine V2 Â· Simulador Â· 2026</span></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  PARTE 2 DEL SCRIPT EN SIGUIENTE MSG  -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

  <script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA FICTICIA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LIDERES = [
  { id:'lnocua', name:'Lnocua' },
  { id:'nimoreno', name:'Nimoreno' },
  { id:'marmendez', name:'Marmendez' },
  { id:'jpuyo', name:'Jpuyo' },
  { id:'lflorez', name:'Lflorez' }
];

const REPS = [
  { id:'pepitoperez', name:'Pepito PÃ©rez', avatar:'PP', color:'#536dfe', lider:'marmendez' },
  { id:'mariagarcia', name:'MarÃ­a GarcÃ­a', avatar:'MG', color:'#00e676', lider:'marmendez' },
  { id:'carlosruiz', name:'Carlos Ruiz', avatar:'CR', color:'#ff5252', lider:'nimoreno' },
  { id:'anamoreno', name:'Ana Moreno', avatar:'AM', color:'#b388ff', lider:'lnocua' },
  { id:'luisdiaz', name:'Luis DÃ­az', avatar:'LD', color:'#ffd600', lider:'jpuyo' },
  { id:'sofialopez', name:'SofÃ­a LÃ³pez', avatar:'SL', color:'#00e5ff', lider:'nimoreno' },
  { id:'diegotorres', name:'Diego Torres', avatar:'DT', color:'#ff9100', lider:'lflorez' },
  { id:'valeriacast', name:'Valeria Castro', avatar:'VC', color:'#69f0ae', lider:'jpuyo' },
  { id:'andresrios', name:'AndrÃ©s RÃ­os', avatar:'AR', color:'#ea80fc', lider:'lflorez' },
  { id:'camilasanch', name:'Camila SÃ¡nchez', avatar:'CS', color:'#ff80ab', lider:'marmendez' },
  { id:'julianmart', name:'JuliÃ¡n MartÃ­nez', avatar:'JM', color:'#80d8ff', lider:'lnocua' },
  { id:'laurabecerr', name:'Laura Becerra', avatar:'LB', color:'#ccff90', lider:'jpuyo' }
];

const PROCESOS = [
  'ReputaciÃ³n ME - Reclamo afecta la reputaciÃ³n',
  'PR - Propiedad Intelectual - Denuncia',
  'GestiÃ³n de PublicaciÃ³n - Modificar variantes',
  'Potenciador - Eventos comerciales T1, T2 y T3',
  'Calidad de Fotos - Mejorar fotos del producto',
  'ReputaciÃ³n ME Ventas - LogÃ­stica Places - Excluimos',
  'Antes de Publicar - CorrecciÃ³n de catÃ¡logo',
  'PR TÃ©cnica - Datos tÃ©cnicos del producto',
  'PR Art Prohib - ArtÃ­culos prohibidos',
  'GestiÃ³n Pub - ModeraciÃ³n de publicaciÃ³n'
];
const SOLUCIONES = [
  'Analizamos reputaciÃ³n y mantenemos impacto','Denuncia recibida - Procedemos con anÃ¡lisis',
  'Modificar variantes, fotos y precio','Beneficios del potenciador explicados',
  'CatÃ¡logo - Sugerencia de correcciÃ³n enviada','LogÃ­stica Places - Excluimos',
  'Fotos actualizadas correctamente','Datos tÃ©cnicos corregidos',
  'ArtÃ­culo restringido - Alternativas','PublicaciÃ³n moderada exitosamente'
];
const COM_P = ['Pudieron solucionar mi problema, excelente','Muy buena ayuda, resolvieron rÃ¡pido','La asesora fue muy amable y clara','Fue buena, me explicaron todo','Excelente servicio, en pocos minutos resuelto','Me ayudaron perfecto con mi publicaciÃ³n','SÃºper rÃ¡pido y efectivo, gracias'];
const COM_D = ['No me solucionaron el problema','No utilizan el criterio ni el sentido comÃºn','Tienen un speech prearmado y no se salen del texto','No terminÃ³ de ayudarme, me cortÃ³ la conversaciÃ³n','El vendedor siempre pierde dinero y tiempo','Tardaron demasiado y no resolvieron','Me pasaron de asesor en asesor sin soluciÃ³n'];
const COM_N = ['Fue normal, ni bien ni mal','Resolvieron pero tardaron bastante','MÃ¡s o menos, esperaba algo mejor','AtenciÃ³n regular, el proceso es largo','No fue mala pero tampoco excelente'];

const LOGROS = [
  { emoji:'ğŸ’', title:'RACHA PERFECTA', desc:'5 promotores seguidos sin parar' },
  { emoji:'ğŸ”¥', title:'EN LLAMAS', desc:'3 promotores consecutivos' },
  { emoji:'ğŸ›¡ï¸', title:'RECUPERACIÃ“N Ã‰PICA', desc:'Promotor despuÃ©s de un detractor' },
  { emoji:'â­', title:'ESTRELLA DEL DÃA', desc:'Mayor NPS del equipo con 5+ encuestas' },
  { emoji:'ğŸš€', title:'PRIMER PROMOTOR', desc:'Â¡ArrancÃ³ el dÃ­a con todo!' },
  { emoji:'ğŸ‘‘', title:'INVICTO', desc:'0 detractores en todo el dÃ­a' }
];

const WEEK = [
  { day:'Lun', enc:14, p:8, n:2, d:4 },
  { day:'Mar', enc:18, p:11, n:3, d:4 },
  { day:'MiÃ©', enc:0, p:0, n:0, d:0 },
  { day:'Jue', enc:0, p:0, n:0, d:0 },
  { day:'Vie', enc:0, p:0, n:0, d:0 }
];
const TODAY_IDX = 2;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let S = {
  p:0, n:0, d:0,
  rachas: {},
  encuestas: [],
  feedStarted: false,
  caseN: 436200000,
  hourN: 8, minN: 5,
  horaData: {},
  // Filters
  filterType: 'all', // all, P, N, D
  filterLider: 'all',
  filterRep: 'all'
};
REPS.forEach(r => S.rachas[r.id] = []);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARTICLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
  const c=document.getElementById('particles');
  const cols=['var(--green)','var(--indigo)','var(--purple)','var(--cyan)','var(--yellow)'];
  for(let i=0;i<25;i++){const p=document.createElement('div');p.className='particle';const s=Math.random()*3+2;p.style.cssText=`width:${s}px;height:${s}px;left:${Math.random()*100}%;background:${cols[i%5]};animation-duration:${Math.random()*14+10}s;animation-delay:${Math.random()*8}s;`;c.appendChild(p);}
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(t){
  document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(e=>e.classList.remove('active'));
  document.getElementById(t==='rt'?'tabRT':'tabSIM').classList.add('active');
  document.getElementById(t==='rt'?'panelRT':'panelSIM').classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateClock(){
  const now=new Date();
  document.getElementById('clockDisplay').textContent=now.toLocaleTimeString('es-CO',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const h=now.getHours(),m=now.getMinutes();
  let next='';
  if(h<12||(h===12&&m<25)) next=`PrÃ³ximo cierre: 12:25 PM en ${12-h-1}h ${60-m}m`;
  else if(h<18||(h===18&&m<30)) next=`PrÃ³ximo cierre: 6:30 PM en ${18-h-1}h ${60-m}m`;
  else next='Cierres del dÃ­a completados âœ…';
  document.getElementById('nextCierre').textContent=next;
  // Auto reset at midnight
  if(h===0&&m===0&&now.getSeconds()<2) autoReset();
}
setInterval(updateClock,1000);
updateClock();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildFilters(){
  // Add filter row before trio if not exists
  if(document.getElementById('filterRow')) return;
  const row=document.createElement('div');
  row.id='filterRow';
  row.style.cssText='display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;align-items:center;padding:0 4px;';

  // NPS Type filter
  row.innerHTML=`
    <div style="display:flex;gap:4px;background:var(--glass);border:1px solid var(--border);border-radius:10px;padding:3px;">
      <button class="fbtn active" data-f="all" onclick="setFilter('type',this,'all')">Todos</button>
      <button class="fbtn" data-f="P" onclick="setFilter('type',this,'P')" style="--fc:var(--green)">ğŸŸ¢ Promotor</button>
      <button class="fbtn" data-f="N" onclick="setFilter('type',this,'N')" style="--fc:var(--yellow)">ğŸŸ¡ Neutro</button>
      <button class="fbtn" data-f="D" onclick="setFilter('type',this,'D')" style="--fc:var(--red)">ğŸ”´ Detractor</button>
    </div>
    <select id="fLider" onchange="setFilter('lider',null,this.value)" style="padding:7px 12px;border-radius:9px;background:var(--bg3);border:1px solid var(--border);color:var(--t1);font-family:Inter;font-size:12px;font-weight:600;cursor:pointer;">
      <option value="all">ğŸ‘¥ Todos los LÃ­deres</option>
      ${LIDERES.map(l=>`<option value="${l.id}">${l.name}</option>`).join('')}
    </select>
    <select id="fRep" onchange="setFilter('rep',null,this.value)" style="padding:7px 12px;border-radius:9px;background:var(--bg3);border:1px solid var(--border);color:var(--t1);font-family:Inter;font-size:12px;font-weight:600;cursor:pointer;">
      <option value="all">ğŸ‘¤ Todos los Reps</option>
      ${REPS.map(r=>`<option value="${r.id}">${r.name}</option>`).join('')}
    </select>
  `;

  // Insert after clock-row
  const clockRow=document.querySelector('.clock-row');
  clockRow.after(row);

  // Inject filter button styles
  const st=document.createElement('style');
  st.textContent=`.fbtn{padding:5px 12px;border-radius:8px;border:none;font-family:Inter;font-size:11px;font-weight:600;cursor:pointer;transition:all 0.25s;background:transparent;color:var(--t2);}
  .fbtn:hover{background:rgba(255,255,255,0.06);color:var(--t1);}
  .fbtn.active{background:var(--glass2);color:var(--t1);box-shadow:0 1px 6px rgba(0,0,0,0.15);}
  .fbtn[data-f="P"].active{background:var(--greenBg);color:var(--green);}
  .fbtn[data-f="N"].active{background:var(--yellowBg);color:var(--yellow);}
  .fbtn[data-f="D"].active{background:var(--redBg);color:var(--red);}`;
  document.head.appendChild(st);
}

function setFilter(kind, btn, val){
  if(kind==='type'){
    S.filterType=val;
    document.querySelectorAll('.fbtn').forEach(b=>b.classList.remove('active'));
    if(btn) btn.classList.add('active');
  } else if(kind==='lider'){
    S.filterLider=val;
    // Update rep dropdown
    const repSel=document.getElementById('fRep');
    const filtered=val==='all'?REPS:REPS.filter(r=>r.lider===val);
    repSel.innerHTML=`<option value="all">ğŸ‘¤ Todos los Reps</option>`+filtered.map(r=>`<option value="${r.id}">${r.name}</option>`).join('');
    S.filterRep='all';
  } else if(kind==='rep'){
    S.filterRep=val;
  }
  applyFilters();
}

function getFiltered(){
  return S.encuestas.filter(e=>{
    if(S.filterType!=='all'&&e.type!==S.filterType) return false;
    if(S.filterLider!=='all'&&e.lider!==S.filterLider) return false;
    if(S.filterRep!=='all'&&e.repId!==S.filterRep) return false;
    return true;
  });
}

function applyFilters(){
  const f=getFiltered();
  const pC=f.filter(e=>e.type==='P').length;
  const nC=f.filter(e=>e.type==='N').length;
  const dC=f.filter(e=>e.type==='D').length;
  const total=f.length;
  const nps=total>0?((pC-dC)/total*100):null;

  // Update Hoy column
  document.getElementById('rtHoyEnc').textContent=total;
  document.getElementById('rtHP').textContent=pC;
  document.getElementById('rtHN').textContent=nC;
  document.getElementById('rtHD').textContent=dC;

  const npsEl=document.getElementById('rtHoyNps');
  const barVal=document.getElementById('rtBarVal');
  const barFill=document.getElementById('rtBarFill');
  const simBarVal=document.getElementById('simBarVal');
  const simBarFill=document.getElementById('simBarFill');

  if(nps===null){
    npsEl.textContent='--%'; npsEl.style.color='var(--t3)';
    barVal.textContent='--%'; barVal.style.color='var(--t3)';
    barFill.style.width='50%'; barFill.style.background='var(--t3)';
    simBarVal.textContent='--%'; simBarVal.style.color='var(--t3)';
    simBarFill.style.width='50%'; simBarFill.style.background='var(--t3)';
  } else {
    const c=nps>=36.6?'var(--green)':nps>=0?'var(--yellow)':'var(--red)';
    const pct=Math.max(2,Math.min(100,(nps+100)/200*100));
    npsEl.textContent=nps.toFixed(1)+'%'; npsEl.style.color=c;
    barVal.textContent=nps.toFixed(1)+'%'; barVal.style.color=c;
    barFill.style.width=pct+'%'; barFill.style.background=`linear-gradient(90deg,${c}88,${c})`;
    simBarVal.textContent=nps.toFixed(1)+'%'; simBarVal.style.color=c;
    simBarFill.style.width=pct+'%'; simBarFill.style.background=`linear-gradient(90deg,${c}88,${c})`;
  }

  // Ayer vs hoy
  document.getElementById('ayerVsHoy').innerHTML=`Ayer a esta hora: <b>8 enc Â· 37.5%</b> â†’ Hoy: <b>${total} enc Â· ${nps!==null?nps.toFixed(1)+'%':'--%'}</b>`;

  // Thermo
  updateThermo(total, nps);

  // Top rep
  updateTopRep(f);
  // Top equipo
  updateTopEquipo(f);

  // Table
  renderTable(f);
  // Chart
  updateChart();
  // Rachas filtered
  renderRachas(f);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THERMO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateThermo(total, nps){
  const el=document.getElementById('rtThermoText');
  const wrap=document.getElementById('rtThermo');
  if(total===0){
    wrap.innerHTML='ğŸ§Š TermÃ³metro del equipo: <span style="margin-left:4px;">Sin actividad aÃºn â€” Â¿QuiÃ©n serÃ¡ el primer promotor del dÃ­a? ğŸš€</span>';
    return;
  }
  let icon,text;
  if(nps>=60){ icon='ğŸ”¥ğŸ”¥ğŸ”¥'; text='Â¡EQUIPO EN LLAMAS! Rendimiento excepcional'; }
  else if(nps>=36.6){ icon='ğŸ”¥ğŸ”¥'; text='Â¡Sobre la meta! El equipo estÃ¡ encendido'; }
  else if(nps>=20){ icon='ğŸ”¥'; text='Buen ritmo, cerquita de la meta'; }
  else if(nps>=0){ icon='ğŸŒ¡ï¸'; text='Tibio, hay que empujar un poco mÃ¡s'; }
  else if(nps>=-30){ icon='ğŸ¥¶'; text='FrÃ­o â€” necesitamos mÃ¡s promotores'; }
  else { icon='â„ï¸'; text='Muy frÃ­o â€” momento de reagrupar y enfocarnos'; }
  wrap.innerHTML=`${icon} TermÃ³metro del equipo: <span style="margin-left:4px;"><b>${text}</b></span>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOP REP / EQUIPO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateTopRep(f){
  const byRep={};
  f.forEach(e=>{
    if(!byRep[e.repId]) byRep[e.repId]={p:0,n:0,d:0,total:0,name:e.repName};
    byRep[e.repId][e.type.toLowerCase()]++;
    byRep[e.repId].total++;
  });
  let best=null, bestNps=-999;
  Object.entries(byRep).forEach(([id,v])=>{
    const nps=(v.p-v.d)/v.total*100;
    if(nps>bestNps||(nps===bestNps&&v.total>(best?best.total:0))){bestNps=nps;best={...v,id};}
  });
  const el=document.getElementById('rtTopRepHoy');
  if(!best){el.innerHTML='<span style="color:var(--t3);font-size:11px;">Esperando encuestas...</span>';return;}
  const c=bestNps>=36.6?'var(--green)':bestNps>=0?'var(--yellow)':'var(--red)';
  el.innerHTML=`<span class="top-card-name">${best.name}</span><span class="top-card-enc">${best.total} enc</span><span class="top-card-nps" style="color:${c}">${bestNps.toFixed(0)}%</span>`;
}

function updateTopEquipo(f){
  const byLider={};
  f.forEach(e=>{
    const lid=e.lider;
    if(!byLider[lid]) byLider[lid]={p:0,n:0,d:0,total:0,name:LIDERES.find(l=>l.id===lid)?.name||lid};
    byLider[lid][e.type.toLowerCase()]++;
    byLider[lid].total++;
  });
  let best=null,bestNps=-999;
  Object.entries(byLider).forEach(([id,v])=>{
    const nps=(v.p-v.d)/v.total*100;
    if(nps>bestNps||(nps===bestNps&&v.total>(best?best.total:0))){bestNps=nps;best={...v,id};}
  });
  const el=document.getElementById('rtTopEqHoy');
  if(!best){el.innerHTML='<span style="color:var(--t3);font-size:11px;">Esperando encuestas...</span>';return;}
  const c=bestNps>=36.6?'var(--green)':bestNps>=0?'var(--yellow)':'var(--red)';
  el.innerHTML=`<span class="top-card-name">${best.name}</span><span class="top-card-enc">${best.total} enc</span><span class="top-card-nps" style="color:${c}">${bestNps.toFixed(0)}%</span>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHART (Horas)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let chartInstance=null;
function initChart(){
  const ctx=document.getElementById('chartHoras').getContext('2d');
  chartInstance=new Chart(ctx,{
    type:'bar',
    data:{
      labels:['8h','9h','10h','11h','12h','13h','14h','15h','16h','17h','18h'],
      datasets:[
        { type:'bar', label:'Encuestas', data:Array(11).fill(0), backgroundColor:'rgba(83,109,254,0.3)', borderColor:'var(--indigo)', borderWidth:1, borderRadius:4, yAxisID:'y1', order:2 },
        { type:'line', label:'NPS %', data:Array(11).fill(null), borderColor:'var(--green)', backgroundColor:'rgba(0,230,118,0.1)', borderWidth:2, pointRadius:3, pointBackgroundColor:'var(--green)', fill:true, tension:0.3, yAxisID:'y', order:1, spanGaps:true }
      ]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      interaction:{mode:'index',intersect:false},
      plugins:{
        legend:{display:true,position:'top',labels:{color:'#8a94a6',font:{size:10,family:'Inter'},boxWidth:12,padding:8}},
        annotation:{annotations:{metaLine:{type:'line',yMin:36.6,yMax:36.6,borderColor:'rgba(255,214,0,0.5)',borderWidth:1,borderDash:[4,4],yScaleID:'y'}}}
      },
      scales:{
        x:{ticks:{color:'#505a6b',font:{size:10}},grid:{color:'rgba(255,255,255,0.03)'}},
        y:{position:'left',min:-100,max:100,ticks:{color:'#505a6b',font:{size:10},callback:v=>v+'%'},grid:{color:'rgba(255,255,255,0.04)'}},
        y1:{position:'right',min:0,ticks:{color:'#505a6b',font:{size:10}},grid:{display:false}}
      }
    }
  });
}

function updateChart(){
  if(!chartInstance) return;
  const f=getFiltered();
  const hours={};
  f.forEach(e=>{
    const h=e.hour;
    if(!hours[h]) hours[h]={p:0,n:0,d:0,total:0};
    hours[h][e.type.toLowerCase()]++;
    hours[h].total++;
  });
  const labels=['8h','9h','10h','11h','12h','13h','14h','15h','16h','17h','18h'];
  const encData=[], npsData=[];
  for(let h=8;h<=18;h++){
    const k=h;
    if(hours[k]&&hours[k].total>0){
      encData.push(hours[k].total);
      npsData.push(((hours[k].p-hours[k].d)/hours[k].total*100));
    } else {
      encData.push(0);
      npsData.push(null);
    }
  }
  chartInstance.data.datasets[0].data=encData;
  chartInstance.data.datasets[1].data=npsData;
  chartInstance.update('none');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RACHAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderRachas(filtered){
  const target=document.getElementById('rtRachas');
  const simTarget=document.getElementById('simRachas');

  // Determine which reps to show based on filters
  let repsToShow=[...REPS];
  if(S.filterLider!=='all') repsToShow=repsToShow.filter(r=>r.lider===S.filterLider);
  if(S.filterRep!=='all') repsToShow=repsToShow.filter(r=>r.id===S.filterRep);

  const sorted=repsToShow.filter(r=>(S.rachas[r.id]||[]).length>0).sort((a,b)=>(S.rachas[b.id]||[]).length-(S.rachas[a.id]||[]).length);

  if(sorted.length===0){
    const empty=`<div class="empty-state"><div class="empty-emoji">ğŸš€</div><div class="empty-title">Â¿QuÃ© esperas?</div><div class="empty-sub">SÃ© el primer promotor del dÃ­a.<br>Cada encuesta cuenta, Â¡arrancamos!</div></div>`;
    target.innerHTML=empty;
    simTarget.innerHTML=empty.replace('Â¿QuÃ© esperas?','Simulador listo').replace('SÃ© el primer promotor','Oprime los botones para');
    return;
  }

  const html=sorted.map(rep=>{
    const dots=S.rachas[rep.id]||[];
    // Apply type filter to dots display
    const filteredDots=S.filterType==='all'?dots:dots; // show all dots but highlight filtered
    const streak=calcStreak(dots);
    const si=streakInfo(streak);
    const pC=dots.filter(d=>d==='P').length, nC=dots.filter(d=>d==='N').length, dC=dots.filter(d=>d==='D').length;
    return `
      <div class="rrow">
        <div class="ravatar" style="background:${rep.color}18;color:${rep.color};border:1px solid ${rep.color}28">${rep.avatar}</div>
        <div class="rinfo">
          <div class="rname">${rep.name} <span style="font-size:9px;color:var(--t3);font-weight:400;">${LIDERES.find(l=>l.id===rep.lider)?.name||''}</span></div>
          <div class="rstats">${dots.length} enc Â· ${pC}P ${nC}N ${dC}D</div>
          <div class="rdots">${dots.map((d,i)=>{
            const dim=S.filterType!=='all'&&d!==S.filterType?'opacity:0.25;':'';
            return `<div class="rdot ${d}" style="animation-delay:${i*0.04}s;${dim}">${d}</div>`;
          }).join('')}</div>
        </div>
        <div class="rstreak" style="background:${si.bg};color:${si.c}">${si.i} ${streak.count}</div>
      </div>`;
  }).join('');

  target.innerHTML=html;
  simTarget.innerHTML=html;
}
function calcStreak(d){if(!d.length)return{type:null,count:0};let l=d[d.length-1],c=0;for(let i=d.length-1;i>=0;i--){if(d[i]===l)c++;else break;}return{type:l,count:c};}
function streakInfo(s){if(!s.type)return{i:'',bg:'transparent',c:'var(--t3)'};return{P:{i:'ğŸ”¥',bg:'var(--greenBg)',c:'var(--green)'},N:{i:'ğŸ˜',bg:'var(--yellowBg)',c:'var(--yellow)'},D:{i:'âš ï¸',bg:'var(--redBg)',c:'var(--red)'}}[s.type];}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTable(f){
  const tbody=document.getElementById('rtTableBody');
  if(!f||f.length===0){
    tbody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:24px;color:var(--t3)">Sin encuestas aÃºn</td></tr>';
    return;
  }
  const sorted=[...f].reverse(); // newest first
  tbody.innerHTML=sorted.map(e=>{
    const pillClass=e.type==='P'?'p':e.type==='N'?'n':'d';
    const npsVal=e.type==='P'?'100%':e.type==='N'?'0%':'-100%';
    return `<tr>
      <td>${e.timeStr}</td>
      <td>${e.caseId}</td>
      <td>${LIDERES.find(l=>l.id===e.lider)?.name||e.lider}</td>
      <td><b>${e.repName}</b></td>
      <td style="max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${e.sol}</td>
      <td style="max-width:220px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-style:italic;">"${e.comment}"</td>
      <td><span class="nps-pill ${pillClass}">${npsVal}</span></td>
    </tr>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEED
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addFeed(html){
  const rtF=document.getElementById('rtFeed');
  const simF=document.getElementById('simFeed');
  if(!S.feedStarted){rtF.innerHTML='';simF.innerHTML='';S.feedStarted=true;}
  rtF.insertAdjacentHTML('afterbegin',html);
  simF.insertAdjacentHTML('afterbegin',html);
  while(rtF.children.length>25)rtF.removeChild(rtF.lastChild);
  while(simF.children.length>25)simF.removeChild(simF.lastChild);
}

function nextCase(){S.caseN+=Math.floor(Math.random()*40)+1;return S.caseN;}
function advanceTime(){
  S.minN+=Math.floor(Math.random()*12)+1;
  if(S.minN>=60){S.minN-=60;S.hourN=Math.min(18,S.hourN+1);}
  return `${S.hourN}:${String(S.minN).padStart(2,'0')}`;
}
function flash(c){const el=document.getElementById(c==='r'?'flR':'flG');el.classList.add('show');setTimeout(()=>el.classList.remove('show'),200);}
function launchConfetti(){const cols=['#00e676','#536dfe','#b388ff','#00e5ff','#ffd600','#ff9100','#ea80fc'];for(let i=0;i<50;i++){const c=document.createElement('div');c.className='confetti';c.style.cssText=`left:${Math.random()*100}%;background:${cols[i%7]};width:${Math.random()*7+4}px;height:${Math.random()*7+4}px;border-radius:${Math.random()>0.5?'50%':'2px'};animation-duration:${Math.random()*1.8+1.2}s;animation-delay:${Math.random()*0.4}s;`;document.body.appendChild(c);setTimeout(()=>c.remove(),3500);}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIMULATORS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function simPromotor(){
  const rep=REPS[Math.floor(Math.random()*REPS.length)];
  const pI=Math.floor(Math.random()*PROCESOS.length);
  const com=COM_P[Math.floor(Math.random()*COM_P.length)];
  const cid=nextCase(), time=advanceTime();

  const enc={type:'P',repId:rep.id,repName:rep.name,lider:rep.lider,proc:PROCESOS[pI],sol:SOLUCIONES[pI],comment:com,caseId:cid,timeStr:time,hour:S.hourN};
  S.encuestas.push(enc);
  S.p++;
  S.rachas[rep.id].push('P');
  if(!S.horaData[S.hourN])S.horaData[S.hourN]={p:0,n:0,d:0};
  S.horaData[S.hourN].p++;

  flash('g');

  const streak=calcStreak(S.rachas[rep.id]);
  const prevDot=S.rachas[rep.id].length>=2?S.rachas[rep.id][S.rachas[rep.id].length-2]:null;

  addFeed(`<div class="acard pro"><div class="ah"><span class="ai">ğŸŸ¢</span><span class="at" style="color:var(--green)">Promotor</span><span class="atm">${time} Â· Caso ${cid}</span></div><div class="ab"><strong>${rep.name}</strong> Â· ${PROCESOS[pI]}<br><em>"${com}"</em></div></div>`);

  applyFilters();

  if(streak.type==='P'&&streak.count===5) setTimeout(()=>showAch('ğŸ’','RACHA PERFECTA',`${rep.name} â€” 5 promotores seguidos`),500);
  else if(streak.type==='P'&&prevDot==='D') setTimeout(()=>showAch('ğŸ›¡ï¸','RECUPERACIÃ“N Ã‰PICA',`${rep.name} â€” Promotor despuÃ©s de detractor`),500);
  else if(S.p===1&&S.n===0&&S.d===0) setTimeout(()=>showAch('ğŸš€','PRIMER PROMOTOR',`${rep.name} â€” Â¡ArrancÃ³ el dÃ­a con todo!`),500);
}

function simDetractor(){
  const rep=REPS[Math.floor(Math.random()*REPS.length)];
  const pI=Math.floor(Math.random()*PROCESOS.length);
  const com=COM_D[Math.floor(Math.random()*COM_D.length)];
  const cid=nextCase(), time=advanceTime();

  const enc={type:'D',repId:rep.id,repName:rep.name,lider:rep.lider,proc:PROCESOS[pI],sol:SOLUCIONES[pI],comment:com,caseId:cid,timeStr:time,hour:S.hourN};
  S.encuestas.push(enc);
  S.d++;
  S.rachas[rep.id].push('D');
  if(!S.horaData[S.hourN])S.horaData[S.hourN]={p:0,n:0,d:0};
  S.horaData[S.hourN].d++;

  flash('r');

  const repDetCount=S.encuestas.filter(e=>e.repId===rep.id&&e.type==='D').length;
  const referente=REPS.filter(r=>r.id!==rep.id)[Math.floor(Math.random()*(REPS.length-1))];
  const esp1=REPS.filter(r=>r.id!==rep.id)[Math.floor(Math.random()*(REPS.length-1))];
  const esp2=REPS.filter(r=>r.id!==rep.id&&r.id!==esp1.id)[Math.floor(Math.random()*(REPS.length-2))];

  addFeed(`<div class="acard det"><div class="ah"><span class="ai">ğŸš¨</span><span class="at" style="color:var(--red)">Detractor Detectado</span><span class="atm">${time} Â· Caso ${cid}</span></div><div class="ab"><strong>${rep.name}</strong> Â· ${PROCESOS[pI]}<br>Sol: ${SOLUCIONES[pI]}<br><em>"${com}"</em></div><div class="espejo"><div class="espejo-t">ğŸ’¡ Casos espejo â€” Promotor en menor tiempo</div><div class="espejo-i">âœ… Caso ${cid-Math.floor(Math.random()*4000)-1000} Â· <b>${esp1.name}</b> Â· ${(Math.random()*7+12).toFixed(1)} min â†’ 100%</div><div class="espejo-i">âœ… Caso ${cid-Math.floor(Math.random()*6000)-2000} Â· <b>${esp2.name}</b> Â· ${(Math.random()*9+13).toFixed(1)} min â†’ 100%</div></div><div class="pbox"><div class="pbox-t">âš ï¸ Contexto histÃ³rico</div><div style="font-size:10px;color:var(--t2);line-height:1.5"><b>${rep.name}</b> lleva <b>${repDetCount} detractor${repDetCount>1?'es':''}</b> en <em>${PROCESOS[pI].split(' - ')[0]}</em> este mes.<br>Referente del equipo: <b>${referente.name}</b></div></div></div>`);

  applyFilters();
}

function simNeutro(){
  const rep=REPS[Math.floor(Math.random()*REPS.length)];
  const pI=Math.floor(Math.random()*PROCESOS.length);
  const com=COM_N[Math.floor(Math.random()*COM_N.length)];
  const cid=nextCase(), time=advanceTime();

  const enc={type:'N',repId:rep.id,repName:rep.name,lider:rep.lider,proc:PROCESOS[pI],sol:SOLUCIONES[pI],comment:com,caseId:cid,timeStr:time,hour:S.hourN};
  S.encuestas.push(enc);
  S.n++;
  S.rachas[rep.id].push('N');
  if(!S.horaData[S.hourN])S.horaData[S.hourN]={p:0,n:0,d:0};
  S.horaData[S.hourN].n++;

  addFeed(`<div class="acard neu"><div class="ah"><span class="ai">ğŸŸ¡</span><span class="at" style="color:var(--yellow)">Neutro</span><span class="atm">${time} Â· Caso ${cid}</span></div><div class="ab"><strong>${rep.name}</strong> Â· ${PROCESOS[pI]}<br><em>"${com}"</em></div></div>`);

  applyFilters();
}

function simPatron(){
  const proc=PROCESOS[Math.floor(Math.random()*PROCESOS.length)].split(' - ')[0];
  const solB=SOLUCIONES[Math.floor(Math.random()*SOLUCIONES.length)];
  const solG=SOLUCIONES[Math.floor(Math.random()*SOLUCIONES.length)];
  const pctD=Math.floor(Math.random()*25)+65;
  const pctP=Math.floor(Math.random()*20)+60;
  const avgT=(Math.random()*7+12).toFixed(1);
  const hora=Math.floor(Math.random()*4)+14;

  addFeed(`<div class="acard pat"><div class="ah"><span class="ai">ğŸ§ </span><span class="at" style="color:var(--indigo)">PatrÃ³n Detectado</span><span class="atm">AnÃ¡lisis histÃ³rico</span></div><div class="ab"><b>${proc}</b> + sol <em>"${solB.substring(0,35)}..."</em><br>â†’ <b style="color:var(--red)">${pctD}% detractores</b> este mes en el equipo</div><div class="pbox"><div class="pbox-t">ğŸ’¡ Alternativa con mejores resultados</div><div style="font-size:10px;color:var(--t2);line-height:1.5">Con <em>"${solG.substring(0,35)}..."</em><br>â†’ <b style="color:var(--green)">${pctP}% promotor</b> Â· Tiempo prom: <b>${avgT} min</b><br>ğŸ“Š DespuÃ©s de las <b>${hora}:00</b> los detractores suben 23% (fatiga)</div></div></div>`);
}

function simLogro(){
  const l=LOGROS[Math.floor(Math.random()*LOGROS.length)];
  const rep=REPS[Math.floor(Math.random()*REPS.length)];
  showAch(l.emoji,l.title,`${rep.name} â€” ${l.desc}`);
}

function showAch(emoji,title,desc){
  document.getElementById('achE').textContent=emoji;
  document.getElementById('achT').textContent=title;
  document.getElementById('achD').textContent=desc;
  document.getElementById('achOv').classList.add('show');
  launchConfetti();
  addFeed(`<div class="acard ach"><div class="ah"><span class="ai">${emoji}</span><span class="at" style="color:var(--purple)">Â¡Logro Desbloqueado!</span></div><div class="ab"><b>${title}</b><br>${desc}</div></div>`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CIERRE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function simCierreAM(){showCierre('am');}
function simCierrePM(){showCierre('pm');}
function showCierre(t){
  const am=t==='am';
  document.getElementById('ciTL').textContent=am?'CIERRE TURNO MAÃ‘ANA':'CIERRE TURNO TARDE';
  document.getElementById('ciHR').textContent=am?'ğŸ“Š 12:25 PM':'ğŸ“Š 6:30 PM';

  WEEK[TODAY_IDX]={day:'MiÃ©',enc:S.p+S.n+S.d,p:S.p,n:S.n,d:S.d};
  const wk=document.getElementById('ciWK');
  wk.innerHTML=WEEK.map((d,i)=>{
    const today=i===TODAY_IDX, future=i>TODAY_IDX;
    const nps=d.enc>0?((d.p-d.d)/d.enc*100):null;
    const c=nps===null?'var(--t3)':nps>=36.6?'var(--green)':nps>=0?'var(--yellow)':'var(--red)';
    return `<div class="ci-day ${today?'today':''} ${future?'future':''}"><div class="ci-dn">${d.day}</div><div class="ci-de">${future?'--':d.enc||'--'}</div><div class="ci-dp" style="color:${future?'var(--t3)':c}">${future?'--':nps!==null?nps.toFixed(1)+'%':'--'}</div></div>`;
  }).join('');

  const wt=WEEK.reduce((a,d)=>({p:a.p+d.p,n:a.n+d.n,d:a.d+d.d,e:a.e+d.enc}),{p:0,n:0,d:0,e:0});
  const wNps=wt.e>0?((wt.p-wt.d)/wt.e*100):null;
  const snEl=document.getElementById('ciSN');
  snEl.textContent=wNps!==null?wNps.toFixed(1)+'%':'--%';
  snEl.style.color=wNps===null?'var(--t3)':wNps>=36.6?'var(--green)':wNps>=0?'var(--yellow)':'var(--red)';

  const mg=document.getElementById('ciMG');
  if(am){
    if(wNps>=36.6) mg.innerHTML='Â¡Vamos por encima de la meta! ğŸ’ª Pueden caer mÃ¡s encuestas en la tarde,<br>Â¡el equipo de maÃ±ana dejÃ³ la vara alta! ğŸ”¥';
    else if(wNps>=15) mg.innerHTML='Vamos cerquita de la meta, aÃºn hay camino. ğŸ“ˆ<br>Â¡Esperemos que la tarde nos ayude a cerrar aÃºn mejor! ğŸ’ª';
    else mg.innerHTML='Semana retadora, pero cada encuesta cuenta. ğŸ›¤ï¸<br>Â¡Esperemos poder cerrar mejor al final del dÃ­a!';
  } else {
    if(wNps>=36.6) mg.innerHTML='Â¡Gran cierre! El equipo lo dio todo. ğŸ†<br>MaÃ±ana seguimos construyendo sobre esta base. Â¡A descansar! ğŸŒ™';
    else if(wNps>=15) mg.innerHTML='AsÃ­ cerramos el panorama de hoy. AÃºn pueden caer encuestas,<br>pero el equipo dio todo. Â¡MaÃ±ana seguimos! ğŸ”¥';
    else mg.innerHTML='DÃ­a retador, pero cada dÃ­a es oportunidad nueva. ğŸŒ…<br>Â¡MaÃ±ana arrancamos con toda! ğŸ’ª';
  }
  document.getElementById('ciOv').classList.add('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO-PLAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let autoTimer=null;
function simAutoPlay(){
  if(autoTimer){clearInterval(autoTimer);autoTimer=null;return;}
  const sequence=['P','P','D','P','N','P','P','P','D','N','P','P','D','P','P','N','P','P','P','D'];
  let i=0;
  switchTab('rt');
  autoTimer=setInterval(()=>{
    if(i>=sequence.length){
      clearInterval(autoTimer);autoTimer=null;
      setTimeout(()=>simPatron(),500);
      setTimeout(()=>simCierrePM(),2500);
      return;
    }
    const t=sequence[i];
    if(t==='P')simPromotor();
    else if(t==='D')simDetractor();
    else simNeutro();
    i++;
  },800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO RESET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function autoReset(){
  S.p=0;S.n=0;S.d=0;S.feedStarted=false;S.hourN=8;S.minN=5;S.encuestas=[];S.horaData={};
  S.filterType='all';S.filterLider='all';S.filterRep='all';
  REPS.forEach(r=>S.rachas[r.id]=[]);
  WEEK[TODAY_IDX]={day:'MiÃ©',enc:0,p:0,n:0,d:0};
  document.getElementById('rtFeed').innerHTML='<div class="empty-state" style="padding:30px 10px;"><div class="empty-emoji" style="font-size:40px;">ğŸ“¡</div><div class="empty-title" style="font-size:15px;">Escuchando...</div><div class="empty-sub" style="font-size:12px;">Las alertas aparecerÃ¡n aquÃ­<br>cuando lleguen encuestas</div></div>';
  document.getElementById('simFeed').innerHTML='<div class="empty-state" style="padding:30px 10px;"><div class="empty-emoji" style="font-size:40px;">ğŸ®</div><div class="empty-title" style="font-size:15px;">Listo para simular</div><div class="empty-sub" style="font-size:12px;">Las alertas simuladas<br>aparecerÃ¡n aquÃ­</div></div>';
  applyFilters();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRE-POPULATE REAL TIME TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function prePopulate(){
  const data=[
    {t:'P',r:0},{t:'P',r:1},{t:'D',r:2},{t:'P',r:3},{t:'N',r:4},
    {t:'P',r:5},{t:'P',r:0},{t:'D',r:6},{t:'P',r:7},{t:'P',r:1},
    {t:'N',r:8},{t:'P',r:9},{t:'D',r:10},{t:'P',r:11},{t:'P',r:3},
    {t:'P',r:5},{t:'N',r:7},{t:'P',r:0},{t:'D',r:2},{t:'P',r:9}
  ];
  data.forEach(d=>{
    const rep=REPS[d.r];
    const pI=Math.floor(Math.random()*PROCESOS.length);
    const com=d.t==='P'?COM_P[Math.floor(Math.random()*COM_P.length)]:d.t==='D'?COM_D[Math.floor(Math.random()*COM_D.length)]:COM_N[Math.floor(Math.random()*COM_N.length)];
    const cid=nextCase(), time=advanceTime();
    const enc={type:d.t,repId:rep.id,repName:rep.name,lider:rep.lider,proc:PROCESOS[pI],sol:SOLUCIONES[pI],comment:com,caseId:cid,timeStr:time,hour:S.hourN};
    S.encuestas.push(enc);
    if(d.t==='P')S.p++;else if(d.t==='D')S.d++;else S.n++;
    S.rachas[rep.id].push(d.t);
    if(!S.horaData[S.hourN])S.horaData[S.hourN]={p:0,n:0,d:0};
    S.horaData[S.hourN][d.t.toLowerCase()]++;
  });

  // Build feed for pre-populated
  S.feedStarted=true;
  const rtF=document.getElementById('rtFeed');
  rtF.innerHTML='';
  [...S.encuestas].reverse().slice(0,10).forEach(e=>{
    const cls=e.type==='P'?'pro':e.type==='D'?'det':'neu';
    const icon=e.type==='P'?'ğŸŸ¢':e.type==='D'?'ğŸš¨':'ğŸŸ¡';
    const label=e.type==='P'?'Promotor':e.type==='D'?'Detractor Detectado':'Neutro';
    const color=e.type==='P'?'var(--green)':e.type==='D'?'var(--red)':'var(--yellow)';
    let extra='';
    if(e.type==='D'){
      const esp1=REPS.filter(r=>r.id!==e.repId)[0];
      const esp2=REPS.filter(r=>r.id!==e.repId)[1];
      const ref=REPS.filter(r=>r.id!==e.repId)[2];
      extra=`<div class="espejo"><div class="espejo-t">ğŸ’¡ Casos espejo â€” Promotor en menor tiempo</div><div class="espejo-i">âœ… Caso ${e.caseId-1200} Â· <b>${esp1.name}</b> Â· ${(Math.random()*6+13).toFixed(1)} min â†’ 100%</div><div class="espejo-i">âœ… Caso ${e.caseId-3400} Â· <b>${esp2.name}</b> Â· ${(Math.random()*8+14).toFixed(1)} min â†’ 100%</div></div><div class="pbox"><div class="pbox-t">âš ï¸ Contexto histÃ³rico</div><div style="font-size:10px;color:var(--t2);line-height:1.5"><b>${e.repName}</b> lleva <b>${S.encuestas.filter(x=>x.repId===e.repId&&x.type==='D').length} detractores</b> en <em>${e.proc.split(' - ')[0]}</em> este mes.<br>Referente: <b>${ref.name}</b></div></div>`;
    }
    rtF.insertAdjacentHTML('beforeend',`<div class="acard ${cls}" style="animation:none;"><div class="ah"><span class="ai">${icon}</span><span class="at" style="color:${color}">${label}</span><span class="atm">${e.timeStr} Â· Caso ${e.caseId}</span></div><div class="ab"><strong>${e.repName}</strong> Â· ${e.proc}<br><em>"${e.comment}"</em></div>${extra}</div>`);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
buildFilters();
initChart();
prePopulate();
applyFilters();
</script>
</body>
</html>
